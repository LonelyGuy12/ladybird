name: build

on:
  push:
  pull_request:

jobs:
  ladybird-build-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/.vcpkg_cache
      VCPKG_FEATURE_FLAGS: manifests,compilertracking,binarycaching
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          verbose: 1
          key: ladybird-ccache-${{ runner.os }}-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake', 'vcpkg.json', 'vcpkg-configuration.json') }}

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            Build/vcpkg
            Build/release/vcpkg_installed
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Cache vcpkg binary archives
        uses: actions/cache@v4
        with:
          path: .vcpkg_cache
          key: vcpkg-bin-${{ runner.os }}-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}
          restore-keys: |
            vcpkg-bin-${{ runner.os }}-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf autoconf-archive automake ccache cmake curl \
            libgl1-mesa-dev libdrm-dev libtool nasm ninja-build pkg-config \
            mesa-common-dev python3-venv python3-dev unzip zip \
            qt6-base-dev qt6-tools-dev qt6-tools-dev-tools qt6-wayland \
            qt6-multimedia-dev libpulse-dev
          mkdir -p ${{ github.workspace }}/.vcpkg_cache
          
          # Configure ccache for optimal performance
          ccache --set-config=compression=true
          ccache --set-config=compression_level=6
          ccache --set-config=max_size=2G
          ccache -z
          echo "ccache configured"

      - name: Configure timezone (workaround for some toolchain date issues)
        run: |
          sudo ln -snf /usr/share/zoneinfo/Etc/UTC /etc/localtime
          echo "Etc/UTC" | sudo tee /etc/timezone

      - name: Build Ladybird
        env:
          VCPKG_BINARY_SOURCES: "clear;files,${{ github.workspace }}/.vcpkg_cache,readwrite"
          CMAKE_BUILD_PARALLEL_LEVEL: 4
          MAKEFLAGS: "-j4"
        run: |
          echo "=== Starting Ladybird build ==="
          ccache -s
          python3 Meta/ladybird.py build
          echo "=== ccache statistics after build ==="
          ccache -s

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            Build/release/**/*.log
            Build/release/**/*.txt

      - name: Package Ladybird as .deb
        if: success()
        run: |
          cd Build/release
          cpack -G DEB

      - name: Upload .deb package
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ladybird-linux-deb
          path: Build/release/*.deb

      - name: Upload binaries (optional)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ladybird-build
          path: |
            Build/release/bin/**
            Build/release/lib/**
            Build/release/*.log

  ladybird-build-macos:
    runs-on: macos-14
    timeout-minutes: 360
    env:
      VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/.vcpkg_cache
      VCPKG_FEATURE_FLAGS: manifests,compilertracking,binarycaching
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies including Clang 19+
        run: |
          brew update
          brew install cmake ninja ccache qt python@3.12 pkg-config wabt autoconf autoconf-archive automake libtool
          # Install LLVM 20 which includes Clang 20
          brew install llvm@20
          # Create symlinks so find_compiler.py can discover Clang 20
          sudo mkdir -p /opt/homebrew/opt/llvm/bin
          sudo ln -sf /opt/homebrew/opt/llvm@20/bin/clang /opt/homebrew/opt/llvm/bin/clang-20
          sudo ln -sf /opt/homebrew/opt/llvm@20/bin/clang++ /opt/homebrew/opt/llvm/bin/clang++-20
          sudo ln -sf /opt/homebrew/opt/llvm@20/bin/clang /opt/homebrew/bin/clang-20
          sudo ln -sf /opt/homebrew/opt/llvm@20/bin/clang++ /opt/homebrew/bin/clang++-20
          ls -la /opt/homebrew/opt/llvm/bin/ || true
          /opt/homebrew/opt/llvm@20/bin/clang --version

      - name: Cache ccache (Clang 20)
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          verbose: 1
          max-size: 2G
          key: ladybird-ccache-clang20-v5-${{ runner.os }}-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake', 'vcpkg.json', 'vcpkg-configuration.json') }}
          restore-keys: |
            ladybird-ccache-clang20-v5-${{ runner.os }}-

      - name: Cache vcpkg source
        uses: actions/cache@v4
        with:
          path: Build/vcpkg
          key: vcpkg-src-clang20-v5-${{ runner.os }}-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}
          restore-keys: |
            vcpkg-src-clang20-v5-${{ runner.os }}-

      - name: Cache vcpkg binary archives (Clang 20)
        uses: actions/cache@v4
        with:
          path: .vcpkg_cache
          key: vcpkg-bin-clang20-v5-${{ runner.os }}-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}
          restore-keys: |
            vcpkg-bin-clang20-v5-${{ runner.os }}-

      - name: Setup build environment
        run: |
          echo "=== Setting up build environment ==="
          # Create vcpkg cache directory
          mkdir -p ${{ github.workspace }}/.vcpkg_cache
          echo "Created .vcpkg_cache directory"
          
          # Configure ccache for optimal performance
          ccache --set-config=compression=true
          ccache --set-config=compression_level=6
          ccache --set-config=max_size=2G
          ccache -z  # Zero statistics
          echo "ccache configured"
          
          # Hide Homebrew GCC to prevent CMake from finding it
          if [ -f /opt/homebrew/bin/gcc ]; then
            sudo mv /opt/homebrew/bin/gcc /opt/homebrew/bin/gcc.hidden || true
          fi
          if [ -f /opt/homebrew/bin/g++ ]; then
            sudo mv /opt/homebrew/bin/g++ /opt/homebrew/bin/g++.hidden || true
          fi
          if [ -f /opt/homebrew/bin/gcc-14 ]; then
            sudo mv /opt/homebrew/bin/gcc-14 /opt/homebrew/bin/gcc-14.hidden || true
          fi
          if [ -f /opt/homebrew/bin/g++-14 ]; then
            sudo mv /opt/homebrew/bin/g++-14 /opt/homebrew/bin/g++-14.hidden || true
          fi
          echo "GCC hidden - only Clang available"
          
          # Verify tools
          which ninja
          which clang-20 || which clang
          echo "Build environment ready"

      - name: Build Ladybird (macOS)
        env:
          CMAKE_MAKE_PROGRAM: /opt/homebrew/bin/ninja
          CMAKE_GENERATOR: Ninja
          VCPKG_BINARY_SOURCES: "clear;files,${{ github.workspace }}/.vcpkg_cache,readwrite"
          # Enable parallel builds
          CMAKE_BUILD_PARALLEL_LEVEL: 8
          MAKEFLAGS: "-j8"
        run: |
          echo "=== Building Ladybird with Homebrew Clang 20 ==="
          echo "Available compilers:"
          which clang-20 || echo "clang-20 not found"
          which clang || echo "clang not found"
          /opt/homebrew/opt/llvm/bin/clang-20 --version || true
          
          # Show ccache stats before build
          ccache -s
          
          # Let find_compiler.py discover Homebrew Clang 20 automatically
          # GCC is hidden, so it will find Clang 20 and use it
          python3 Meta/ladybird.py build
          
          # Show ccache stats after build
          echo "=== ccache statistics after build ==="
          ccache -s

      - name: Create DMG package
        if: success()
        run: |
          echo "=== Creating clean DMG with only Ladybird.app ==="
          
          # Find the built app bundle
          APP_BUNDLE=$(find Build/release -name "Ladybird.app" -type d | head -1)
          
          if [ -z "$APP_BUNDLE" ]; then
            echo "ERROR: Ladybird.app not found!"
            find Build/release -name "*.app" -type d
            exit 1
          fi
          
          echo "Found app bundle: $APP_BUNDLE"
          
          # Create a temporary directory for DMG contents
          DMG_DIR="Build/dmg_staging"
          mkdir -p "$DMG_DIR"
          
          # Copy only the app bundle
          cp -R "$APP_BUNDLE" "$DMG_DIR/"
          
          # Create Applications symlink for easy drag-and-drop
          ln -s /Applications "$DMG_DIR/Applications"
          
          # Create DMG using hdiutil (native macOS tool)
          DMG_NAME="Ladybird-0.1.0-macOS-arm64.dmg"
          hdiutil create -volname "Ladybird" \
            -srcfolder "$DMG_DIR" \
            -ov -format UDZO \
            "Build/release/$DMG_NAME"
          
          echo "=== DMG created successfully ==="
          ls -lh "Build/release/$DMG_NAME"

      - name: Upload DMG artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ladybird-macos-dmg
          path: Build/release/*.dmg
          if-no-files-found: warn

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-macos
          path: |
            Build/release/**/*.log
            Build/release/**/*.txt

      - name: Upload binaries (optional)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ladybird-build-macos
          path: |
            Build/release/bin/**
            Build/release/lib/**
            Build/release/*.log
